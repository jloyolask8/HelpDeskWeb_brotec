<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:pe="http://primefaces.org/ui/extensions">

    <ui:composition template="/script/template_inbox.xhtml">
        <ui:define name="title">
            <h:outputText value="Nueva Regla de Negocio"></h:outputText>
        </ui:define>
        <ui:define name="west">
            <p:accordionPanel multiple="true" cache="true">
                <p:tab title="Reglas de negocio" id="accionestab1">
                    <h:outputLabel escape="false" value="#{bundle.ayudaReglas}"/>
                </p:tab>
            </p:accordionPanel>
        </ui:define>
        <ui:define name="body">

            <h:form id="form">

                <h1>Nueva Regla de Negocio</h1>

                <p:separator/>
                <p:messages id="messages"/>
                <h:panelGrid>

                    <h:panelGrid columns="2">
                        <p:outputLabel value="Nombre:" for="idTrigger" style="font-weight: bold;"/>
                        <p:inputText id="idTrigger" value="#{reglaTriggerController.selected.idTrigger}" size="60" maxlength="40" 
                                     title="#{bundle.CreateReglaTriggerTitle_idTrigger}" required="true" 
                                     requiredMessage="#{bundle.CreateReglaTriggerRequiredMessage_idTrigger}"/>

                    

                        <p:outputLabel value="Ejecutar Cuando: " for="eventoid" style="font-weight: bold;"/>
                        <p:selectOneMenu id="eventoid" rendered="#{reglaTriggerController.selected ne null}"  value="#{reglaTriggerController.selected.evento}" 
                                         required="true" requiredMessage="Seleccione el Evento al cual esta asociada esta regla.">
                            <f:selectItem itemLabel="Se Cree un nuevo caso" itemValue="CREATE"/>
                            <f:selectItem itemLabel="Se Modifique un caso" itemValue="UPDATE"/>
                        </p:selectOneMenu>

                        
                    </h:panelGrid>

                    <p:dataTable id="filtrosVista" value="#{reglaTriggerController.selected.condicionList}" var="filtro" >                     

                        <f:facet name="header">
                            <h:outputText value="Condiciones"/>
                        </f:facet>



                        <p:column headerText="Atributo">
                            <p:selectOneMenu id="idCampox"  value="#{filtro.idCampo}" 
                                             panelStyle="width:170px" style="width:160px"  filter="true" filterMatchMode="startsWith"
                                             required="true" requiredMessage="Favor Seleccione Attributo.">
                                <f:selectItem itemLabel="seleccione un atributo" itemValue="" noSelectionOption="true"/>
                                <f:selectItems value="#{reglaTriggerController.filterHelper.comparableFields}" var="comparableField" itemValue="#{comparableField.idCampo}" itemLabel="#{comparableField.label}"/>
                                <p:ajax update=":form:messages :form:filtrosVista" listener="#{reglaTriggerController.handleIdCampoChangeEvent()}"/>
                            </p:selectOneMenu>

                        </p:column>

                        <p:column headerText="Operador">

                            <p:selectOneMenu id="idComparador" value="#{filtro.idComparador}" rendered="#{filtro.idCampo ne null}"
                                               filter="true" filterMatchMode="startsWith"
                                             required="true" requiredMessage="Favor Seleccione Operador.">
                                <f:selectItem itemLabel="Operador..." itemValue="" noSelectionOption="true"/>
                                <f:selectItems value="#{reglaTriggerController.filterHelper.findTipoComparacionesAvailable(filtro.idCampo)}" var="tipoComparador" itemValue="#{tipoComparador}" itemLabel="#{tipoComparador.nombre}" itemDescription="#{tipoComparador.descripcion}"/>
                                <p:ajax update=":form:messages :form:filtrosVista" listener="#{reglaTriggerController.handleAnyChangeEvent()}"/>
                            </p:selectOneMenu>

                        </p:column>

                        <p:column headerText="#{bundle.ListFiltroVistaTitle_valor}">
                            <p:inputText id="valortext" value="#{filtro.valor}" rendered="#{filtro.idCampo ne null and filtro.idComparador ne null and reglaTriggerController.filterHelper.getComparableField(filtro.idCampo).fieldTypeId.fieldTypeId eq 'TEXT'}" 
                                         required="true" requiredMessage="Se necesita un valor para comparar."/>
                            <p:selectOneRadio id="valorradio" value="#{filtro.valor}" rendered="#{filtro.idCampo ne null and filtro.idComparador ne null and reglaTriggerController.filterHelper.getComparableField(filtro.idCampo).fieldTypeId.fieldTypeId eq 'RADIO'}">
                                <f:selectItems value="#{reglaTriggerController.filterHelper.findPosibleOptionsIncludingAllPlaceHolders(filtro.idCampo, UserSessionBean.current)}" />
                            </p:selectOneRadio>

                            <p:selectOneMenu id="valorentity1" value="#{filtro.valor}" panelStyle="width:300px" style="width:180px"  filter="true" filterMatchMode="contains"
                                             rendered="#{filtro.idCampo ne null and filtro.idComparador ne null and reglaTriggerController.filterHelper.getComparableField(filtro.idCampo).fieldTypeId.fieldTypeId eq 'SELECTONE_ENTITY' and filtro.idComparador.idComparador ne 'SC' and filtro.idCampo ne 'emailCliente'}">
                                <f:selectItems value="#{reglaTriggerController.filterHelper.findPosibleOptionsIncludingAllPlaceHolders(filtro.idCampo, UserSessionBean.current)}" />
                            </p:selectOneMenu>

                            <p:autoComplete value="#{filtro.valor}"
                                            id="valorentity11" completeMethod="#{emailClienteController.completeEmailCliente}"  
                                            var="email"  itemValue="#{email.emailCliente}" itemLabel="#{email}"
                                            required="true" requiredMessage="Debe Seleccionar un email."
                                            rendered="#{filtro.idCampo ne null and filtro.idComparador ne null and reglaTriggerController.filterHelper.getComparableField(filtro.idCampo).fieldTypeId.fieldTypeId eq 'SELECTONE_ENTITY' and filtro.idComparador.idComparador ne 'SC' and filtro.idCampo eq 'emailCliente'}">  

                                <f:facet name="itemtip">  
                                    <h:panelGrid  columns="2" cellpadding="5">  
                                        <f:facet name="header">  
                                            <h:outputText value="#{email.emailCliente}" />  
                                        </f:facet>  

                                        <h:outputText value="Nombre: " />  
                                        <h:outputText value="#{email.cliente.nombres}" />  

                                        <h:outputText value="Apellidos: " />  
                                        <h:outputText value="#{email.cliente.apellidos}" /> 

                                        <h:outputText value="Rut: " />  
                                        <h:outputText value="#{email.cliente.rut}" /> 
                                    </h:panelGrid>  
                                </f:facet>  

                            </p:autoComplete>  

                            <p:selectCheckboxMenu id="valorentity2" label="Selección..."   value="#{filtro.valoresList}" filter="true" filterMatchMode="contains"
                                                  panelStyle="width:300px" style="width:180px"
                                                  rendered="#{filtro.idCampo ne null and filtro.idComparador ne null and reglaTriggerController.filterHelper.getComparableField(filtro.idCampo).fieldTypeId.fieldTypeId eq 'SELECTONE_ENTITY' and filtro.idComparador.idComparador eq 'SC'}">
                                <f:selectItems value="#{reglaTriggerController.filterHelper.findPosibleOptions(filtro.idCampo, UserSessionBean.current)}" />
                            </p:selectCheckboxMenu>

                            <p:selectOneMenu id="valorcheckboolean" value="#{filtro.valor}" rendered="#{filtro.idCampo ne null and filtro.idComparador ne null and reglaTriggerController.filterHelper.getComparableField(filtro.idCampo).fieldTypeId.fieldTypeId eq 'CHECKBOX'}">
                                <f:selectItems value="#{reglaTriggerController.filterHelper.findPosibleOptionsIncludingAllPlaceHolders(filtro.idCampo, UserSessionBean.current)}" />
                            </p:selectOneMenu>
                            <script>
                                $(function() {
                                    $( ".datepicker" ).datepicker({
                                        dateFormat: "dd/mm/yy"
                                    });
                                });
                            </script>
                            <p:inputText id="valorcalendar1" styleClass="datepicker" value="#{filtro.valor}"  title="Desde:"
                                         rendered="#{filtro.idCampo ne null and filtro.idComparador ne null and reglaTriggerController.filterHelper.getComparableField(filtro.idCampo).fieldTypeId.fieldTypeId eq 'CALENDAR'}" />
                            <p:inputText id="valorcalendar2" styleClass="datepicker" value="#{filtro.valor2}"  title="Hasta:"
                                         rendered="#{filtro.idCampo ne null and filtro.idComparador ne null and reglaTriggerController.filterHelper.getComparableField(filtro.idCampo).fieldTypeId.fieldTypeId eq 'CALENDAR' and filtro.idComparador.idComparador eq 'BW'}" />

                        </p:column>


                        <p:column>
                            <f:facet name="header">

                                <p:commandButton icon="ui-icon-plus" actionListener="#{reglaTriggerController.addNewFiltroVista}" immediate="true"
                                                 update=":form:messages :form:filtrosVista" value="Agregar Criterio" />
                            </f:facet>
                            <p:commandButton icon="ui-icon-close" actionListener="#{reglaTriggerController.removeFiltroFromVista(filtro)}" ajax="true" immediate="true"
                                             update=":form" value="Quitar" />
                        </p:column>
                    </p:dataTable>

                    <br/>

                    <p:outputPanel id="acciones">
                        <p:dataTable value="#{reglaTriggerController.acciones}" var="accion" id="accionesTable">
                            <p:column>
                                <f:facet name="header">
                                    <h:outputText value="Acción" />
                                </f:facet>
                                <h:outputText id="nombreAccionx" value="#{accion.idNombreAccion.nombre}" />
                                <p:tooltip for="nombreAccionx" value="Parametro(s): #{accion.parametros}" style="width: 550px;"/>

                            </p:column>



                            <p:column>
                                <f:facet name="header">
                                    <p:commandButton value="Agregar" onclick="addAccionPopup.show();" type="button"/>
                                </f:facet>
                                <p:commandLink value="Remover" update=":form:acciones" process=":form:acciones">
                                    <p:collector value="#{accion}" removeFrom="#{reglaTriggerController.acciones}" unique="true"/>
                                </p:commandLink>
                            </p:column>

                            <f:facet name="header">
                                <h:outputText value="Acciones"/>
                            </f:facet>

                            <f:facet name="footer">
                                <h:outputText value="* Estas acciones se realizarán al cumplirse TODAS las condiciones de la Regla."/>
                            </f:facet>

                        </p:dataTable>
                    </p:outputPanel>

                    <h:panelGrid columns="2">
                        <p:outputLabel value="#{bundle.CreateReglaTriggerLabel_desccripcion}" for="descripcion" />                        
                        <p:inputTextarea rows="4" cols="60" id="descripcion" value="#{reglaTriggerController.selected.desccripcion}" title="#{bundle.CreateReglaTriggerTitle_desccripcion}" />
                    </h:panelGrid>


                </h:panelGrid>


                <br/>
                <p:commandButton action="#{reglaTriggerController.create}" value="#{bundle.CreateAreaSaveLink}" ajax="false"/>                     
                <p:commandButton action="#{reglaTriggerController.prepareList}" value="Volver a las Reglas" immediate="true" ajax="false" icon="ui-icon-folder-open"/>

            </h:form>



            <p:dialog id="modalDialogAcciones" header="Agregar Acción" widgetVar="addAccionPopup" modal="true" appendTo="@(body)" height="300" width="700">

                <h:form id="accionForm">
                    <h:panelGrid columns="3">

                        <p:outputLabel value="Seleccione Acción:" for="idNombreAccion" />
                        <p:selectOneMenu id="idNombreAccion" value="#{reglaTriggerController.accionTemp.idNombreAccion}" 
                                         required="true">
                            <p:ajax update=":accionForm" listener="#{reglaTriggerController.resetTempVars()}"/>
                            <f:selectItems value="#{nombreAccionController.itemsAvailableSelectOne}"/>
                        </p:selectOneMenu>
                        <p:message for="idNombreAccion"/>

                        <p:outputLabel value="#{bundle.CreateAccionLabel_parametros}" rendered="#{reglaTriggerController.esAccionAsignarAGrupo() or
                                                reglaTriggerController.esAccionAsignarAUsuario() or reglaTriggerController.esAccionCambiarPrioridad() or
                                                reglaTriggerController.esAccionEnviarEmail() or reglaTriggerController.esAccionCambioCat() or
                                                reglaTriggerController.esAccionCustom()}"/>

                        <p:selectOneMenu value="#{reglaTriggerController.accionParametroArea}" 
                                         rendered="#{reglaTriggerController.esAccionAsignarArea()}">
                            <p:ajax update=":accionForm"/>
                            <f:selectItems value="#{areaController.itemsAvailableSelectOne}"/>
                        </p:selectOneMenu>

                        <p:selectOneMenu id="idAccionCustom" label="Action Class" filter="true" filterMatchMode="contains"
                                         value="#{reglaTriggerController.accionTemp.parametros}" style="width: 100%;"
                                         required="true" requiredMessage="Se requiere que seleccione una clase que implemente la Accion."                                   
                                         rendered="#{reglaTriggerController.esAccionCustom()}">

                            <f:selectItems value="#{reglaTriggerController.actionClassNames}"/>
                        </p:selectOneMenu>

                        <p:selectOneMenu value="#{reglaTriggerController.accionParametroGrupo}" 
                                         rendered="#{reglaTriggerController.esAccionAsignarAGrupo()}">
                            <p:ajax update=":accionForm"/>
                            <f:selectItems value="#{grupoController.itemsAvailableSelectOne}"/>
                        </p:selectOneMenu>

                        <p:selectOneMenu value="#{reglaTriggerController.accionParametroUsuario}" 
                                         rendered="#{reglaTriggerController.esAccionAsignarAUsuario()}">
                            <p:ajax update=":accionForm"/>
                            <f:selectItems value="#{usuarioController.itemsAvailableSelectOneNoSystem}"/>
                        </p:selectOneMenu>

                        <p:selectOneMenu value="#{reglaTriggerController.accionParametroPrioridad}" 
                                         rendered="#{reglaTriggerController.esAccionCambiarPrioridad()}">
                            <p:ajax update=":accionForm"/>
                            <f:selectItems value="#{prioridadController.itemsAvailableSelectOne}"/>
                        </p:selectOneMenu>

                        <p:commandButton rendered="#{reglaTriggerController.esAccionEnviarEmail()}" update=":accionForm :formrespuesta"
                                         value="Componer email" action="#{reglaTriggerController.crearEmailTemp()}" oncomplete="#{p:widgetVar('mailcomposer')}.show()"/>

                        <p:inputText value="#{reglaTriggerController.accionTemp.parametros}" id="idAccionCat" required="true" requiredMessage="Se requiere un parametro"
                                     title="#{bundle.CreateAccionLabel_parametros}"
                                     rendered="#{reglaTriggerController.esAccionCambioCat()}">
                            <p:ajax event="click" listener="#{casoController.actualizaArbolDeCategoria}" update=":formArbol:arbol" oncomplete="#{p:widgetVar('idDialogArbol')}.show()"/>
                        </p:inputText>
                        <p:message for="idAccionCat" rendered="#{reglaTriggerController.esAccionCambioCat()}"/>

                    </h:panelGrid>

                    <p:commandButton id="btn_add" value="Agregar Acción" update=":form:acciones :accionForm :form:messages" action="#{reglaTriggerController.prepareCreateAccion()}" ajax="true"/>
                    <p:commandButton value="Cerrar" ajax="true"  onclick="addAccionPopup.hide()"   />
                </h:form>

            </p:dialog>


            <p:dialog id="idDialogArbol" header="Seleccione area" widgetVar="selCat" modal="true" appendTo="@(body)" width="400" height="300">
                <h:form id="formArbol">
                    <div align="left">
                        <p:tree id="arbol" value="#{categoriaController.categorias}" var="node" dynamic="true" cache="false"
                                selectionMode="single" selection="#{reglaTriggerController.catNodeSelected}"
                                style="border-color: window;">
                            <p:ajax event="select" update=":accionForm" oncomplete="selCat.hide()"/>
                            <p:treeNode expandedIcon="myfoldericon16"
                                        collapsedIcon="myfoldericon16">
                                <h:outputText value="#{node.nombre}" />
                            </p:treeNode>
                        </p:tree>
                    </div>
                </h:form>
            </p:dialog>
            <p:dialog id="mailcomposer" header="Compositor Email" widgetVar="mailComposerWidget" modal="true" appendTo="@(body)" height="420" width="600">
                <h:form id="formrespuesta">

                    <h:panelGrid rendered="#{reglaTriggerController.emailTemp ne null}">
                        <h:panelGrid columns="2">
                            <h:outputLabel value="para:" for="emailCliente2" />
                            <p:inputText id="emailCliente2" value="#{reglaTriggerController.emailTemp.toAdress}" title="email destino" style="width: 494px;"/>
                            <h:outputLabel value="asunto:" for="emailSubject" />
                            <p:inputText id="emailSubject" value="#{reglaTriggerController.emailTemp.subject}" title="asunto" style="width: 494px;"/>
                        </h:panelGrid>
                        <pe:ckEditor value="#{reglaTriggerController.emailTemp.body}"
                                     toolbar="[
                                     { name: 'document', items : [ 'Source','Preview','Print' ] },
                                     { name: 'clipboard', items : [ 'Cut','Copy','Paste','PasteText','PasteFromWord','-','Undo','Redo' ] },
                                     { name: 'editing', items : [ 'SpellChecker', 'Scayt' ] },
                                     { name: 'insert', items : [ 'Table','HorizontalRule','SpecialChar','PageBreak'] },
                                     '/',
                                     { name: 'basicstyles', items : [ 'Bold','Italic','Underline','Strike','Subscript','Superscript','-','RemoveFormat' ] },
                                     { name: 'paragraph', items : [ 'NumberedList','BulletedList','-','Outdent','Indent','-','Blockquote','-','JustifyLeft','JustifyCenter','JustifyRight','JustifyBlock'] },
                                     '/',
                                     { name: 'styles', items : [ 'Styles','Format','Font','FontSize' ] },
                                     { name: 'colors', items : [ 'TextColor','BGColor' ] },
                                     { name: 'tools', items : [ 'Maximize', 'ShowBlocks'] }

                                     ]"

                                     id="respuesta" width="560" height="190"/>


                        <p:commandButton id="btn_add_action" value="Agregar Acción" update=":form:acciones :accionForm :form:messages :formrespuesta" 
                                         action="#{reglaTriggerController.prepareCreateAccionEmail()}" ajax="true" oncomplete="mailComposerWidget.hide()"/>

                        <p:commandButton value="Cerrar" ajax="true" onclick="mailComposerWidget.hide()"   />
                    </h:panelGrid>



                </h:form>
            </p:dialog>

        </ui:define>
    </ui:composition>

</html>
