<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:pe="http://primefaces.org/ui/extensions"
      xmlns:go="http://java.sun.com/jsf/composite/go">

    <ui:composition template="/script/template_inbox_bootstrap_config.xhtml">
        <ui:define name="title">
            <h:outputText value="Reglas de negocio"/>
        </ui:define>
        <ui:define name="help">
            <p:panel>
                <h:outputLabel escape="false" value="#{bundle.ayudaReglas}"/>
                    <br/>
                    <h:outputLabel value="Orden ejecutar reglas" style="font-weight: bold"/>
                    <h:outputLabel value="Cuando un caso es creado o actualizado, GoDesk gatilla estas reglas de negocio en orden para que se ejecuten. 
                                   Es importante asegurarse de que las reglas de negocio estén en el orden correcto de ejecución, para esto en la lista de reglas 
                                   de negocio puede ordenar la ejecución de las reglas simplemente tomando y arrastrar a la posición deseada en la lista."/>
            </p:panel>
        </ui:define>
        
       <ui:define name="content_header">
            <script>
                var init = [];
                init.push(function () {
                    $('body').addClass('mmc');
                });
            </script>

            <!-- page-header -->
            <div class="page-header">
                <div class="row">
                    <div class="col-sm-6 col-xs-12">
                        <h1><i class="fa fa-key page-header-icon"></i>&nbsp;&nbsp;Reglas de negocio</h1>
                        <p:commandLink title="Help" onclick="PF('helpDialog').show()" styleClass="text-info" >
                            <i class="fa fa-info-circle"/>
                        </p:commandLink> 
                    </div>
                    <div class="col-sm-6 col-xs-12">
                        <h:form id="buttonsForm">

                            <div class="pull-right">

                                <div class="btn-group">
                                    <go:paginatorCounts controllerMBean="#{reglaTriggerController}"/>
                                </div>

                                <go:paginatorBtnsBt controllerMBean="#{reglaTriggerController}" update="@(form)"/>

                                <button type="button" class="btn dropdown-toggle" data-toggle="dropdown"><i class="fa fa-bars"></i></button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <h:commandLink action="#{reglaTriggerController.prepareCreate}" 
                                                       value="#{bundle.ListReglaCreateLink}"
                                     rendered="#{filtroAcceso.verificarAccesoAFuncionEditarAjustes()}">
                                        </h:commandLink>
                                    </li>

                                </ul>

                            </div>
                        </h:form>
                    </div>
                </div>
            </div><!-- / .page-header --> 
        </ui:define>
        
        
        <ui:define name="body">

             <style type="text/css">
                .ui-tooltip {
                    width: 500px;
                    max-width: 500px;
                }
            </style>
            
             <go:vistasListBt id="vistasList" 
                             update="@(form)" 
                             controllerMBean="#{reglaTriggerController}"
                             user="#{UserSessionBean.current}"/>
            <div class="panel search-panel">
               <h:form id="formfilter">
                <go:filterView id="panelFilter0" titleIconClass="fa fa-filter page-header-icon"
                               controllerMBean="#{reglaTriggerController}" 
                               vista="#{reglaTriggerController.vista}"
                               filterHelper="#{reglaTriggerController.filterHelper}" 
                               canChangeFilters="#{filtroAcceso.verificarAccesoAFiltrosIndex()}"
                               update=":mainform:messages :form" vistaControllerBackOutcome="/script/reglaTrigger/List"/>

            </h:form>
            </div>
             
            

           

            <h:form id="form">
                <script type="text/javascript">
                    jQuery(function() {
                        jQuery('.ui-datatable tbody').sortable({
                            update: function(event, ui) {
                                var x = ui["item"].parent().children().map(
                                        function() {
                                            return $(this).attr("data-ri");
                                            //I guess data-ri is attribute generated by primefaces which contains index of each row
                                        }
                                ).get().join(",");
                                reorderTable([{name: 'newOrder', value: x}]);
                            }
                        }
                        );
                    });
                </script>



                <p:dataTable id="tablareglas" value="#{reglaTriggerController.items}" var="item"                                     
                             emptyMessage="#{bundle.ListReglaEmpty}" 
                             rowKey="#{item.idTrigger}">




                    <p:column >
                        <f:facet name="header">
                            <h:outputText value="Descripci&oacute;n"/>
                        </f:facet>
                        <h:panelGroup id="nombreDescripcion">
                            <i class="fa fa-bars" style="cursor: move;"> &nbsp; </i>

                            &nbsp;
                            <h:outputText id="Nombre" value="#{item.idTrigger}" style="font-weight: bold;"/>
                            &nbsp;
                            <h:outputText id="evento" title=""
                                          value="#{item.desccripcion}" escape="false"/>
                        </h:panelGroup>
                        <pe:tooltip for="nombreDescripcion" value="#{item.toString()}" />
                    </p:column>

                    <p:column headerText="Estado" exportable="false">
                        <p:selectBooleanButton style="width: 50px; height: 20px;" id="EstadoRegla" value="#{item.reglaActiva}" onLabel="ON" offLabel="OFF" onIcon="ui-icon-check" offIcon="ui-icon-close">  
                            <p:ajax update=":form" listener="#{reglaTriggerController.update(item)}"/>  
                        </p:selectBooleanButton>  
                        <p:tooltip for="EstadoRegla" value="#{item.desccripcion}"/>

                    </p:column>



                    <p:column headerText="Acción">
                        <p:commandButton id="editBtn" ajax="false" action="#{reglaTriggerController.prepareEdit(item)}" title="Editar" icon="ui-icon ui-icon-pencil"/>
                        <p:commandButton id="showDialogButton" title="Eliminar" update=":form:confirmDialog" action="#{reglaTriggerController.setSelected(item)}" oncomplete="PF('confirmation').show()" icon="ui-icon ui-icon-trash"/>
                    </p:column>

                    <f:facet name="footer">

                    </f:facet>


                </p:dataTable>

                <p:dialog id="confirmDialog" showEffect="fade" hideEffect="fade" 
                          header="Iniciando proceso de eliminación" widgetVar="confirmation">

                    <h:outputText value="Está seguro de eliminar la regla #{reglaTriggerController.selected.idTrigger}?"/>

                    <f:facet name="footer">
                        <p:commandButton id="confirm" value="#{bundle.yesDelete}" action="#{reglaTriggerController.destroySelected()}" 
                                         ajax="false"/>
                        <p:commandButton id="decline" value="#{bundle.decline}" onclick="PF('confirmation').hide()" type="button" /> 
                    </f:facet>

                </p:dialog>

                <br />

                <h:inputHidden id="hiddenmyonoffswitch" valueChangeListener="#{reglaTriggerController.valueChangeListener(e)}"/>
                <p:remoteCommand name="updateMessage" update=":form:tablareglas"/>

            </h:form>
            <h:form>
                <p:remoteCommand
                    name="reorderTable"
                    actionListener="#{reglaTriggerController.reorderTable}"
                    update=":form"
                    />
            </h:form>
        </ui:define>
    </ui:composition>


</html>
