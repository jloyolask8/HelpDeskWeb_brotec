<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:pe="http://primefaces.org/ui/extensions"
      xmlns:go="http://java.sun.com/jsf/composite/go">

    <ui:composition template="/script/template_inbox.xhtml">
        <ui:define name="title">
            <p:outputLabel value="Reglas de negocio"/>
        </ui:define>
        <ui:define name="west">

            <go:vistasList id="vistasList" update=":vistasList:vistasForm :mainform:messages :formfilter:panelFilter0:panelFilter :form" 
                           controllerMBean="#{reglaTriggerController}"
                           user="#{UserSessionBean.current}"/>


            <br/>

            <p:panel>
                <h:outputLabel escape="false" value="#{bundle.ayudaReglas}"/>
                <br/>
                <h:outputLabel value="Ordering triggers" style="font-weight: bold"/>
                <h:outputLabel value="When a ticket is created or updated, Itcs helpdesk runs through all the triggers in order. 
                               So it's important to make sure your triggers are in the right order.                                   
                               New triggers are added to the bottom of the triggers list. "/>
            </p:panel>
        </ui:define>
        <ui:define name="body">

            <h:form id="formfilter">
                <go:filterView id="panelFilter0" titleIconClass="fa fa-filter page-header-icon"
                               controllerMBean="#{reglaTriggerController}" 
                               vista="#{reglaTriggerController.vista}"
                               filterHelper="#{reglaTriggerController.filterHelper}" 
                               canChangeFilters="#{filtroAcceso.verificarAccesoAFiltrosIndex()}"
                               update=":mainform:messages :form" vistaControllerBackOutcome="/script/reglaTrigger/List"/>

            </h:form>

            <style type="text/css">
                .ui-tooltip {
                    width: 500px;
                    max-width: 500px;
                }
            </style>

            <h:form id="form">
                <script type="text/javascript">
                    jQuery(function() {
                        jQuery('.ui-datatable tbody').sortable({
                            update: function(event, ui) {
                                var x = ui["item"].parent().children().map(
                                        function() {
                                            return $(this).attr("data-ri");
                                            //I guess data-ri is attribute generated by primefaces which contains index of each row
                                        }
                                ).get().join(",");
                                reorderTable([{name: 'newOrder', value: x}]);
                            }
                        }
                        );
                    });
                </script>


                <p:toolbar>



                    <p:toolbarGroup align="right">

                        <go:paginatorButtons controllerMBean="#{reglaTriggerController}" update=":form"/>
                        <p:separator/>

                        <p:commandButton ajax="false" action="#{reglaTriggerController.prepareCreate}" immediate="true"
                                         value="Crear regla" icon="ui-icon ui-icon-plus" rendered="#{filtroAcceso.verificarAccesoAFuncionEditarAjustes()}" />
                        <p:separator/>
                        <p:commandButton ajax="false" action="#{reglaTriggerController.updateAllJustToFixLabels()}" 
                                         value="UPDATE LABELS" rendered="#{filtroAcceso.esUsuarioSistema()}" />


                    </p:toolbarGroup>  

                </p:toolbar>

                <p:dataTable id="tablareglas" value="#{reglaTriggerController.items}" var="item"                                     
                             emptyMessage="#{bundle.ListReglaEmpty}" 
                             rowKey="#{item.idTrigger}">




                    <p:column >
                        <f:facet name="header">
                            <h:outputText value="Descripci&oacute;n"/>
                        </f:facet>
                        <h:panelGroup id="nombreDescripcion">
                            <i class="fa fa-bars" style="cursor: move;"> &nbsp; </i>

                            &nbsp;
                            <h:outputText id="Nombre" value="#{item.idTrigger}" style="font-weight: bold;"/>
                            &nbsp;
                            <h:outputText id="evento" title=""
                                          value="#{item.desccripcion}" escape="false"/>
                        </h:panelGroup>
                        <pe:tooltip for="nombreDescripcion" value="#{item.toString()}" />
                    </p:column>

                    <p:column headerText="Estado" exportable="false">
                        <p:selectBooleanButton style="width: 50px; height: 20px;" id="EstadoRegla" value="#{item.reglaActiva}" onLabel="ON" offLabel="OFF" onIcon="ui-icon-check" offIcon="ui-icon-close">  
                            <p:ajax update=":form" listener="#{reglaTriggerController.update(item)}"/>  
                        </p:selectBooleanButton>  
                        <p:tooltip for="EstadoRegla" value="#{item.desccripcion}"/>

                    </p:column>



                    <p:column headerText="Acción">
                        <p:commandButton id="editBtn" ajax="false" action="#{reglaTriggerController.prepareEdit(item)}" title="Editar" icon="ui-icon ui-icon-pencil"/>
                        <p:commandButton id="showDialogButton" title="Eliminar" update=":form:confirmDialog" action="#{reglaTriggerController.setSelected(item)}" oncomplete="PF('confirmation').show()" icon="ui-icon ui-icon-trash"/>
                    </p:column>

                    <f:facet name="footer">

                    </f:facet>


                </p:dataTable>

                <p:dialog id="confirmDialog" showEffect="fade" hideEffect="fade" 
                          header="Iniciando proceso de eliminación" widgetVar="confirmation">

                    <h:outputText value="Está seguro de eliminar la regla #{reglaTriggerController.selected.idTrigger}?"/>

                    <f:facet name="footer">
                        <p:commandButton id="confirm" value="#{bundle.yesDelete}" action="#{reglaTriggerController.destroySelected()}" 
                                         ajax="false"/>
                        <p:commandButton id="decline" value="#{bundle.decline}" onclick="PF('confirmation').hide()" type="button" /> 
                    </f:facet>

                </p:dialog>

                <br />

                <h:inputHidden id="hiddenmyonoffswitch" valueChangeListener="#{reglaTriggerController.valueChangeListener(e)}"/>
                <p:remoteCommand name="updateMessage" update=":form:tablareglas"/>

            </h:form>
            <h:form>
                <p:remoteCommand
                    name="reorderTable"
                    actionListener="#{reglaTriggerController.reorderTable}"
                    update=":form"
                    />
            </h:form>
        </ui:define>
    </ui:composition>


</html>
