<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:pe="http://primefaces.org/ui/extensions">

    <ui:composition template="/script/template_inbox.xhtml">
        <ui:define name="title">
            <p:outputLabel value="Reglas de negocio"/>
        </ui:define>
        <ui:define name="west">
            <p:panel>
                    <h:outputLabel escape="false" value="#{bundle.ayudaReglas}"/>
                    <br/>
                    <h:outputLabel value="Ordering triggers" style="font-weight: bold"/>
                    <h:outputLabel value="When a ticket is created or updated, Itcs helpdesk runs through all the triggers in order. 
                                   So it's important to make sure your triggers are in the right order.                                   
                                   New triggers are added to the bottom of the triggers list. "/>
            </p:panel>
        </ui:define>
        <ui:define name="body">
            <style type="text/css">
                .ui-tooltip {
                    width: 500px;
                    max-width: 500px;
                }
            </style>
           
            <h:form id="form">
                <script type="text/javascript">
                    jQuery(function() {
                        jQuery('.ui-datatable tbody').sortable({
                            update: function(event, ui) {
                                var x = ui["item"].parent().children().map(
                                        function() {
                                            return $(this).attr("data-ri");
                                            //I guess data-ri is attribute generated by primefaces which contains index of each row
                                        }
                                ).get().join(",");
                                reorderTable([{name: 'newOrder', value: x}]);
                            }
                        }
                        );
                    });
                </script>

                <p:dataTable id="tablareglas" value="#{reglaTriggerController.items}" var="item"                                     
                             emptyMessage="#{bundle.ListReglaEmpty}" 
                             rowKey="#{item.idTrigger}">

                    <f:facet name="header">
                        <h:outputText value="&nbsp;" style="float: left;"></h:outputText>
                        <div align="right" >
                            <p:outputPanel style="margin-top: -2px">  
                                <p:inputText id="globalFilter" value="#{reglaTriggerController.searchPattern}"
                                             style="width:250px;height:12px; border-radius: 4em; text-align: left; padding-left: 10px;" />  
                                <p:watermark for="globalFilter" value="buscar" id="watermark"/>
                                <p:commandButton value="" icon="fa fa-search"
                                                 style="float: right; background: none; border: 0px !important;top: 4px;"
                                                 actionListener="#{reglaTriggerController.prepareList()}" update=":form"/>
                            </p:outputPanel>
                        </div>
                    </f:facet>

                    

                    <p:column >
                        <f:facet name="header">
                            <h:outputText value="Descripci&oacute;n"/>
                        </f:facet>
                        <h:panelGroup id="nombreDescripcion">
                            <i class="fa fa-bars"> &nbsp; <p:outputLabel value="#{item.orden}." /></i>
                            
                              &nbsp;
                            <h:outputText id="Nombre" value="#{item.idTrigger}" style="font-weight: bold;"/>
                            &nbsp;
                            <h:outputText id="evento" title=""
                                          value="#{item.desccripcion}" escape="false"/>
                        </h:panelGroup>
                        <pe:tooltip for="nombreDescripcion" value="#{item.toString()}" />
                    </p:column>
                    
                     <p:column headerText="Estado" exportable="false">
                        <p:selectBooleanButton style="width: 50px; height: 20px;" id="EstadoRegla" value="#{item.reglaActiva}" onLabel="ON" offLabel="OFF" onIcon="ui-icon-check" offIcon="ui-icon-close">  
                            <p:ajax update=":form" listener="#{reglaTriggerController.update(item)}"/>  
                        </p:selectBooleanButton>  
                        <p:tooltip for="EstadoRegla" value="#{item.desccripcion}"/>

                    </p:column>



                    <p:column headerText="Acci칩n">
                        <p:commandButton id="editBtn" ajax="false" action="#{reglaTriggerController.prepareEdit(item)}" title="Editar" icon="ui-icon ui-icon-pencil"/>
                        <p:commandButton id="showDialogButton" title="Eliminar" update=":form:confirmDialog" action="#{reglaTriggerController.setSelected(item)}" oncomplete="PF('confirmation').show()" icon="ui-icon ui-icon-trash"/>
                    </p:column>

                    <f:facet name="footer">
                        <p:toolbar style="border: none;">
                           <p:toolbarGroup align="left">

                                <p:outputLabel value="P치ginas de "/>
                                <p:selectOneMenu id="cant" value="#{reglaTriggerController.paginationPageSize}" style="top: 7px" >
                                    <p:ajax event="change" listener="#{reglaTriggerController.filter()}" update=":form"/>
                                    <f:selectItems value="#{reglaTriggerController.pagination.pageSizesAvailable}"/>
                                </p:selectOneMenu>

                                <p:separator/>
                                <h:outputText value="#{reglaTriggerController.pagination.pageFirstItem + 1}-#{reglaTriggerController.pagination.pageLastItem + 1} de #{reglaTriggerController.pagination.itemsCount}" rendered="#{reglaTriggerController.pagination.itemsCount gt 0}"></h:outputText>
                                <p:separator/>
                                <p:commandButton action="#{reglaTriggerController.first}" update=":form" disabled="#{not reglaTriggerController.pagination.hasPreviousPage}" icon="ui-icon ui-icon-seek-first" rendered="#{reglaTriggerController.pagination.itemsCount > 0}"/>
                                <p:commandButton action="#{reglaTriggerController.previous}" update=":form" disabled="#{not reglaTriggerController.pagination.hasPreviousPage}" icon="ui-icon ui-icon-seek-prev" rendered="#{reglaTriggerController.pagination.itemsCount > 0}"/>
                                <p:commandButton action="#{reglaTriggerController.next}" update=":form" disabled="#{not reglaTriggerController.pagination.hasNextPage}" icon="ui-icon ui-icon-seek-next" rendered="#{reglaTriggerController.pagination.itemsCount > 0}"/>
                                <p:commandButton action="#{reglaTriggerController.last}" update=":form" disabled="#{not reglaTriggerController.pagination.hasNextPage}" icon="ui-icon ui-icon-seek-end" rendered="#{reglaTriggerController.pagination.itemsCount > 0}"/>
                                <p:separator/>

                                <p:commandButton ajax="false" action="#{reglaTriggerController.prepareCreate}" value="Crear regla" icon="ui-icon ui-icon-plus" rendered="#{filtroAcceso.verificarAccesoAFuncionEditarAjustes()}" />

                                <p:commandButton ajax="false" action="#{reglaTriggerController.updateAllJustToFixLabels()}" 
                                                 value="UPDATE LABELS" rendered="#{filtroAcceso.esUsuarioSistema()}" />

                           </p:toolbarGroup>
                        </p:toolbar>
                    </f:facet>


                </p:dataTable>

                <p:dialog id="confirmDialog" showEffect="fade" hideEffect="fade" 
                          header="Iniciando proceso de eliminaci칩n" widgetVar="confirmation">

                    <h:outputText value="Est치 seguro de eliminar la regla #{reglaTriggerController.selected.idTrigger}?"/>

                    <f:facet name="footer">
                        <p:commandButton id="confirm" value="#{bundle.yesDelete}" action="#{reglaTriggerController.destroySelected()}" 
                                         ajax="false"/>
                        <p:commandButton id="decline" value="#{bundle.decline}" onclick="PF('confirmation').hide()" type="button" /> 
                    </f:facet>

                </p:dialog>

                <br />

                <h:inputHidden id="hiddenmyonoffswitch" valueChangeListener="#{reglaTriggerController.valueChangeListener(e)}"/>
                <p:remoteCommand name="updateMessage" update=":form:tablareglas"/>

            </h:form>
            <h:form>
                <p:remoteCommand
                    name="reorderTable"
                    actionListener="#{reglaTriggerController.reorderTable}"
                    update=":form"
                    />
            </h:form>
        </ui:define>
    </ui:composition>


</html>
