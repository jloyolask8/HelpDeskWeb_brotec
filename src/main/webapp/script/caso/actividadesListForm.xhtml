<!DOCTYPE html [
    <!ENTITY nbsp "&#160;"> 
    ]>
    <ui:composition 
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:c="http://java.sun.com/jsp/jstl/core"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:p="http://primefaces.org/ui"
        xmlns:pe="http://primefaces.org/ui/extensions"
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:go="http://java.sun.com/jsf/composite/go">

        <pe:importEnum type="com.itcs.helpdesk.persistence.entityenums.EnumTipoNota" var="EnumTipoNota" allSuffix="ALL_ENUM_VALUES" />

        <h:form id="formact">

            <h:panelGroup layout="block" styleClass="timeline" rendered="#{not empty casoController.selected.notaList}">

                <c:forEach items="#{casoController.selected.notaList}" var="item" varStatus="loop">


                    <div class="tl-entry">
                        <div class="tl-time">
                            <h:outputText value="#{casoController.prettyDate(item.fechaCreacion)}"/>
                        </div>
                        <div class="tl-icon #{item.visible ? 'bg-info':'bg-gray'}"><i class="fa #{item.tipoNota.styleIcon ne null ? item.tipoNota.styleIcon:'fa-comment'}"></i></div>
                        <div class="panel tl-body">
                            <h4 class="text-default">
                                <h:outputText value="\##{item.idNota} #{item.creadaPor ne null ? item.creadaPor.capitalName:(item.enviadoPor ne null ? item.enviadoPor:'unknown sender')}"/></h4>
                            <div class="expandable">
                                <h:outputText value="#{casoController.extractNotaNewPart(item)}" escape="false"/>
                            </div>

                            <h:panelGroup rendered="#{not empty item.attachmentList}">

                                <hr/>
                                <h6 class="text-light-gray text-semibold text-xs" style="margin:20px 0 10px 0;">ADJUNTOS</h6>

                            </h:panelGroup>

                            <c:forEach items="#{item.attachmentList}" var="nota_f_attachment" >
                                <h:panelGrid columns="6">
                                    <p:graphicImage name="file_extension_#{nota_f_attachment.fileExtension}.png" library="file_extension_icons" />

                                    <p:commandLink ajax="false" value="#{nota_f_attachment.nombreArchivoOriginal}" 

                                                   title="Descargar #{nota_f_attachment.nombreArchivo} (#{nota_f_attachment.mimeType})">
                                        <p:fileDownload value="#{casoController.bajarArchivo(nota_f_attachment.idAttachment)}" />
                                    </p:commandLink>

                                    <h:outputText value="(#{nota_f_attachment.fileSizeHuman})" style="color: #7A7A7A"/>


                                    <p:lightBox iframe="true" iframeTitle="#{nota_f_attachment.nombreArchivoOriginal}"
                                                rendered="#{nota_f_attachment.isPdf() or nota_f_attachment.isImage()}"> 
                                        <h:outputLink  value="#{facesContext.externalContext.requestContextPath}/DownloadFileServlet?id=#{nota_f_attachment.idAttachment}&amp;tenant=#{UserSessionBean.tenantId}" 
                                                       styleClass="ui-icon ui-icon-search"
                                                       title="Preview">  
                                        </h:outputLink>
                                    </p:lightBox>


                                </h:panelGrid>
                            </c:forEach>

                            <hr/>

                            <span class="text-light-gray">#{casoController.creaTituloDeNota(item)}</span>

                            <p:outputPanel layout="block" styleClass="pull-right">

                                <p:commandLink styleClass="btn-link" ajax="true"
                                               actionListener="#{casoController.changeNotaVisibility(item, item.visible)}" 
                                               update="@parent" >
                                    <i class="#{item.visible ? 'fa fa-eye':'fa fa-eye-slash'}" 
                                       title="#{item.visible ? 'Visible al público':'Privado'}"/>
                                </p:commandLink>
                                &nbsp;
                                <p:commandLink actionListener="#{casoController.prepareEditNota(item)}"
                                               update=":formEditNota"
                                               onsuccess="PF('Nota').show();" rendered="#{casoController.notaEditable(item)}" 
                                               styleClass="btn-link">
                                    <span class="btn-label icon fa fa-edit" title="Editar"></span>
                                </p:commandLink>
                                &nbsp;
                                <p:commandLink actionListener="#{casoController.prepareViewHtml(item.texto)}"
                                               rendered="#{not casoController.mobileClient}"
                                               styleClass="btn-link">
                                    <span class="btn-label icon fa fa-external-link" title="Abrir mensaje original"></span>
                                </p:commandLink>
                            </p:outputPanel>

                        </div> <!-- / .tl-body -->
                    </div> <!-- / .tl-entry -->


                </c:forEach>

                <script type="text/javascript">

                    $('div.expandable').expander({
                        slicePoint: 50,
                        widow: 2,
                        expandEffect: 'fadeIn',
                        expandSpeed: 250,
                        collapseEffect: 'fadeOut',
                        collapseSpeed: 200,
                        // allow the user to re-collapse the expanded text.
                        userCollapse: true,
                        expandText: '[ + ]', // default is 'read more'
                        userCollapseText: '[ - ]'  // default is 'read less'
                    });

                </script>

            </h:panelGroup>




            <div class="panel panel-body-colorful">
                <div class="panel-heading">
                    <span class="panel-title">#{casoController.selected.emailCliente.nombreOEmailCliente} escribió: </span>
                    <div class="panel-heading-controls">
                        <div class="panel-heading-icon"><i class="fa fa-inbox"></i></div>
                    </div>
                </div>
                <div class="panel-body">


                    <p:inplace editor="true" disabled="#{casoController.selected.closed}">
                        <f:facet name="output">

                            <div class="expandable">
                                <h:outputText 
                                    value="#{casoController.selected.descripcionTxt}" 
                                    escape="false"/>
                            </div>


                        </f:facet>
                        <f:facet name="input">

                            <go:textAreaEditor fieldValue="#{casoController.selected.descripcionTxt}"
                                               mobile="#{casoController.mobileClient}"  watermark="Descripción del caso"
                                               required="true" requiredMessage="Ingrese Descripción del caso"/>
                        </f:facet>
                    </p:inplace>

                </div>
                <div class="panel-footer">

                    <div align="left" style="font-size: x-small;">
                        <p class="text-light-gray">Oprima sobre la descripción si desea editar. 
                            La descripción del caso se muestra en texto plano por seguridad, para ver el original haz click en 
                            ver mensaje HTML</p>
                    </div>

                    <p:commandLink actionListener="#{casoController.prepareViewHtml(casoController.selected.descripcion)}"
                                   styleClass="btn-link">
                        <span class="btn-label icon fa fa-external-link"></span>
                    </p:commandLink>
                </div>
            </div>





        </h:form>

    </ui:composition>
